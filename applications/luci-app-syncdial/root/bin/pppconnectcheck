#!/bin/sh
#PPPoE拨号在线接口数检测及重拨脚本
#Copyright (C) 2015 GuoGuo<gch981213@gmail.com>
. /lib/functions.sh

[ -f /etc/config/syncdial ] || {
	echo "You are missing configuration file /etc/config/macvlan"
	return 1
}

config_load "syncdial"
config_get_bool dialchk config dialchk 0
config_get dial config dialnum
[ "$dialchk" = "0" ] && {
	echo "dial check disabled."
	return 0
}
[ $(ps | grep -c "pppconnectcheck") -gt 3 ] && logger -t PPPoE-IFChecker "Another checker is running.exit." && return 1
sleep 50
PPPUPNUM=$(mwan3 status | grep -c "is online (tracking active)")
logger -t PPPoE-IFChecker "$PPPUPNUM interfaces are online."
if [ "$PPPUPNUM" -lt $dial ]
then
	logger -t PPPoE-IFChecker "Reconnect interfaces."
	killall -9 pppd
	logger -t PPPoE-IFChecker "Interfaces restarted."
	logger -t PPPoE-IFChecker "Another checker will be started 10s later."
	sleep 10 && pppconnectcheck &
else
	logger -t PPPoE-IFChecker "Nothing to do.Exit."
fi
return 0
